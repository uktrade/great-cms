{% load static %}
{% load wagtailcore_tags %}
{% load url_map %}

{% if not request.user.is_authenticated %}
  {% include 'components/header_footer/global_header.html' with header_class="domestic" %}
{% endif %}

<header class="magna-header clearfix" id="header" dir="ltr" data-ga-section="header">
  {% with is_wagtail_page=page %}
    {% if is_wagtail_page %}
      {% include "wagtailseo/meta.html" %}
    {% endif %}
  {% endwith %}
  {% path_match "^\/export-plan\/" as in_exportplan %}
  <nav class="main-nav container">
    <a id="header-logo-link" class="magna-header__logo" href="/">
      <img src="{% static 'images/DBT_White.svg' %}" alt="Department for Business & Trade" id="header-logo-exporting-is-great">
    </a>

    <ul class="magna-header__extra-links">
      {% if request.user.is_authenticated %}
        <li><a href="{% slugurl 'dashboard' %}">Dashboard</a></li>
      {% else %}
        <li><a href="{% url 'core:login' %}">Sign in</a></li>
      {% endif %}
    </ul>

    <div class="magna-header__menu">
      <button type="button" class="magna-header__dropdown-button{% if not request.user.is_authenticated %} hide-lg{% endif %}" data-reveal-button data-reveal-modal aria-controls="main-menu">
        Menu
        <span class="magna-header__dropdown-button__icon"></span>
      </button>

      <div id="main-menu" class="magna-header__dropdown">
        {% if request.user.is_authenticated %}
          <div class="magna-header__greeting">Hi {{ request.user.first_name }}</div>
        {% endif %}

        <ul class="magna-header__menu-items">
          {% if request.user.is_authenticated %}
            <li><a href="{% slugurl 'dashboard' %}">Dashboard</a></li>
            <li><a href="/learn/categories/">Learn to export</a></li>
            <li><a href="{% url "core:compare-countries"%}">Where to export</a></li>
            <li><a href="/export-plan/">Make an export plan</a></li>

            <li><a href="/profile/">Account</a></li>
          {% endif %}

          <li><a href="/advice/">Advice</a></li>
          <li><a href="/markets/">Markets</a></li>
          <li><a href="/services/">Services</a></li>

          {% if request.user.is_authenticated %}
            <li>
              {% url 'sso:business-sso-logout-api' as sign_out_endpoint %}
              <script>
                function signOut() {
                  return fetch('{{ sign_out_endpoint }}', {
                    method: 'post',
                    headers: {
                      Accept: 'application/json',
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{ csrf_token }}',
                      'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: JSON.stringify({})
                  }).then(function() {
                    window.location = '/';
                  });
                }
              </script>
              <button type="button" onclick="signOut()">Sign out</button>
            </li>
          {% else %}
            <li>
              <a class="button margin-top-15 margin-bottom-15" href="{% url 'core:login' %}">Sign in</a>
            </li>
          {% endif %}
        </ul>
      </div>
      <div class="magna-header__overlay"></div>

      <form id="magna-header-search-form" class="magna-header__search" action="{% url 'search:search' %}" method="GET">
        <label for="magna-header-search-box" class="visually-hidden">Search</label>
        <input id="magna-header-search-box" type="text" name="q" placeholder="Search">
        <button>
          <span class="visually-hidden">Search</span>
        </button>
      </form>

      <ul id="services-area" class="magna-header__nav hide-lg_lt">
        {% if request.user.is_authenticated %}
          {% path_match "^\/learn\/" as in_learning %}
          {% path_match "^\/where-to-export\/" as in_targetmarkets %}
          <li><a id="header-link-learning" class="{% if in_learning %}active{% endif %}" href="/learn/categories/">Learn to export</a></li>
          <li><a id="header-link-markets" class="{% if in_targetmarkets %}active{% endif %}" href="{% url 'core:compare-countries'%}">Where to export</a></li>
          <li><a id="header-link-exporting-plan" class="{% if in_exportplan %}active{% endif %}" href="/export-plan/">Make an export plan</a></li>
        {% else %}
          <li><a id="header-link-advice" href="/advice/">Advice</a></li>
          <li><a id="header-link-markets-lo" href="/markets/">Markets</a></li>
          <li><a id="header-link-services" href="/services/">Services</a></li>
        {% endif %}
      </ul>
    </div>
  </nav>
</header>
