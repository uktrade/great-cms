{% load static %}
{% load wagtailcore_tags %}
{% load url_map %}
{% load get_digital_entry_point_enabled from content_tags %}
{% get_digital_entry_point_enabled as FEATURE_DIGITAL_POINT_OF_ENTRY %}

{% if not request.user.is_authenticated %}
  {% include 'components/header_footer/global_header.html' with header_class="domestic" %}
{% endif %}

<header class="great-header great-bg-dark-blue" id="header" dir="ltr" data-ga-section="header">
  <div class="great-container">
    <a id="header-logo-link" class="govuk-!-margin-top-7 govuk-!-margin-bottom-4 great-header-logo" href="/">
      <img src="{% static 'images/DBT_White.svg' %}" alt="Department for Business and Trade" id="header-logo-exporting-is-great" />
    </a>

    {% path_match "^\/export-plan\/" as in_exportplan %}
    <nav>
      <ul id="services-area" class="great-header-services govuk-!-margin-bottom-4">
        {% if request.user.is_authenticated %}
          {% path_match "^\/learn\/" as in_learning %}
          {% path_match "^\/where-to-export\/" as in_targetmarkets %}
          <li><a id="header-link-learning" class="govuk-!-padding-3 {% if in_learning %}active{% endif %}" href="/learn/categories/">Learn to export</a></li>
          <li><a id="header-link-markets" class="govuk-!-padding-3 {% if in_targetmarkets %}active{% endif %}" href="{% url 'core:compare-countries'%}">Where to export</a></li>
          <li><a id="header-link-exporting-plan" class="govuk-!-padding-3 {% if in_exportplan %}active{% endif %}" href="/export-plan/">Make an export plan</a></li>
        {% else %}
          <li><a id="header-link-advice" href="/advice/" class="govuk-!-padding-3">Advice</a></li>
          <li><a id="header-link-markets-lo" href="/markets/" class="govuk-!-padding-3">Markets</a></li>
          <li><a id="header-link-services" href="/services/" class="govuk-!-padding-3">Services</a></li>
          {% if FEATURE_DIGITAL_POINT_OF_ENTRY %}
            <li><a id="header-link-support" href="/support/support" class="govuk-!-padding-3">Support</a></li>
          {% endif %}
        {% endif %}
      </ul>

      <form id="magna-header-search-form" class="magna-header__search govuk-!-margin-bottom-4" action="{% url 'search:search' %}" method="GET">
        <label for="magna-header-search-box" class="visually-hidden">Search</label>
        <input id="magna-header-search-box" class="" type="text" name="q" placeholder="Search">
        <button>
          <span class="visually-hidden">Search</span>
        </button>
      </form>

      <button type="button" class="great-header-menu-button govuk-!-margin-left-6 govuk-!-margin-bottom-4" data-reveal-button data-reveal-modal aria-controls="main-menu">
        Menu
        <span class="magna-header__dropdown-button__icon"></span>
      </button>

      <div id="main-menu" class="great-header-menu-dropdown magna-header__dropdown">
        {% if request.user.is_authenticated %}
            <div class="magna-header__greeting">Hi {{ request.user.first_name }}</div>
          {% endif %}

          <ul class="great-header-menu-items magna-header__menu-items">
            {% if request.user.is_authenticated %}
              <li><a href="{% slugurl 'dashboard' %}">Dashboard</a></li>
              <li><a href="/learn/categories/">Learn to export</a></li>
              <li><a href="{% url "core:compare-countries"%}">Where to export</a></li>
              <li><a href="/export-plan/">Make an export plan</a></li>

              <li><a href="/profile/">Account</a></li>
            {% endif %}

            <li><a href="/advice/">Advice</a></li>
            <li><a href="/markets/">Markets</a></li>
            <li><a href="/services/">Services</a></li>
            {% if FEATURE_DIGITAL_POINT_OF_ENTRY %}
              <li><a href="/support/support">Support</a></li>
            {% endif %}

            {% if request.user.is_authenticated %}
              <li>
                {% url 'sso:business-sso-logout-api' as sign_out_endpoint %}
                <script>
                  function signOut() {
                    return fetch('{{ sign_out_endpoint }}', {
                      method: 'post',
                      headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'X-Requested-With': 'XMLHttpRequest',
                      },
                      body: JSON.stringify({})
                    }).then(function() {
                      window.location = '/';
                    });
                  }
                </script>
                <button type="button" onclick="signOut()">Sign out</button>
              </li>
            {% else %}
              <li>
                <a class="button margin-top-15 margin-bottom-15" href="{% url 'core:login' %}">Sign in</a>
              </li>
            {% endif %}
          </ul>
        </div>
        <div class="magna-header__overlay"></div>
        <ul class="great-header-actions govuk-!-margin-bottom-4 govuk-!-margin-top-0">
          {% if request.user.is_authenticated %}
            <li><a href="{% slugurl 'dashboard' %}"class="govuk-!-padding-3">Dashboard</a></li>
          {% else %}
            <li><a href="{% url 'core:login' %}"class="govuk-!-padding-3">Sign in</a></li>
          {% endif %}
        </ul>
      </div>
    </nav>
  </div>
</header>
