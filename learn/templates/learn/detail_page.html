{% extends 'core/base.html' %}
{% load wagtailimages_tags %}
{% load routablepageurl from wagtailroutablepage_tags %}
{% load url_map %}
{% load content_tags %}
{% load breadcrumbs from component_tags %}
{% block content %}
    <div class="great-container">
        {% breadcrumbs page great-breadcrumbs %}
        <a href={{ BREADCRUMBS_ROOT_URL|default:"/" }}>great.gov.uk</a>
        <a href="/learn/categories/">Learn to export</a>
        <a href={{ page.get_parent.get_parent.url }}>{{ page.get_parent.get_parent.title|default:"/" }}</a>
    {% endbreadcrumbs %}
</div>
<div class="lesson-page">
    {% get_category_title_for_lesson page as category_title %}
    <div class="container p-v-s">
        {% include "./return_link.html" with link=backlink title=backlink_title class="only-mobile" %}
        <div class="grid lesson-body p-t-s">
            <div class="c-1-4 only-desktop"></div>
            <div class="c-1-2">
                <h1 class="h-l" id="lesson-title">{{ page.title }}</h1>
                <div class="duration-container">
                    <i class="fa fa-clock"></i>
                    <span class="learn__category-topics">{{ page.estimated_read_duration|format_timedelta }} read</span>
                </div>
                <div class="lesson-hero media-section">{% include 'learn/hero_media_item.html' %}</div>
                {% include 'core/objectives.html' %}
                <div class="lesson-body-blocks">{% include 'core/personalised_body.html' %}</div>
            </div>
            <div class="c-1-4 back-section only-desktop">
                {% include "./return_link.html" with link=backlink title=backlink_title class="only-desktop" %}
            </div>
        </div>
    </div>
</div>
<div class="test-knowledge">
    <div class="container">
        <div class="grid p-t-m">
            <div class="c-1-4 only-desktop">
                <span>&nbsp;</span>
            </div>
            <div class="c-1-2">
                {% include 'learn/recap.html' %}
                <hr class="hr hr--light m-0" />
            </div>
            <div class="c-1-4 only-desktop">
                <span>&nbsp;</span>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="grid p-v-s">
            <div class="c-1-4 only-desktop">
                <span>&nbsp;</span>
            </div>
            <div class="c-1-2">
                <fieldset id="mark_as_complete">
                </fieldset>
            </div>
            <div class="c-1-4 only-desktop">
                <span>&nbsp;</span>
            </div>
        </div>
    </div>
    <div class="container p-v-s">
        <div class="grid">
            <div class="c-1-12 only-desktop">
                <span>&nbsp;</span>
            </div>
            <div class="c-10-12 m-b-m">
                {% if next_lesson %}
                    {% include "./return_link.html" with link=backlink title=backlink_title class="only-mobile" %}
                    <div class="card card--horizontal">
                        <div class="card__section">
                            <p class="body-l-b m-0">Your next lesson</p>
                            <h2 class="h-m p-t-xxs">{{ next_lesson.title }}</h2>
                            {% if next_lesson.estimated_read_duration %}
                                <div class="duration-container p-b-xs">
                                    <i class="fa fa-clock"></i>
                                    <span class="learn__category-topics">{{ next_lesson.estimated_read_duration|format_timedelta }}</span>
                                </div>
                            {% endif %}
                            {% if next_module %}
                                <p class="m-t-xs m-b-xs">
                                    Part of your next module:
                                    <br />
                                    <strong>{{ next_module.title }}</strong>
                                </p>
                            {% endif %}
                            <a href="{{ next_lesson.get_url }}" class="button primary-button m-b-xs">Continue learning</a>
                        </div>
                        <div class="card__section card__section--image">
                            <div class="card__image">
                                {% comment %}<!--
                  If `next_module` is present, we want to use the image from that ahead of `current_module`
                                -->{% endcomment %}
                                {% with next_module|default:current_module as appropriate_module %}
                                    {% image appropriate_module.image original as module_image %}
                                    <img src="{{ module_image.url }}" alt="{{ module_image.alt }}" />
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
            <div class="c-1-12 only-desktop">
                <span>&nbsp;</span>
            </div>
        </div>
        {% include "core/includes/backlink.html" with url=page.get_parent.get_parent.url label=category_title classes="only-desktop back-link--inverse m-f-s" %}
    </div>
</div>
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script>
    {% if request.user.is_authenticated %}
      dataLayer.push({
        event: 'lessonView',
        lessonModule: '{{ current_module }}',
        topicTitle: '{{ page_topic }}',
        lessonTitle: '{{ page.title }}'
      });
      magna.createMarkLessonAsComplete({
        element: document.querySelector("#mark_as_complete"),
        endpoint: '{% url "sso:lesson-completed" lesson=page.id %}'
      })
    {% endif %}

    document.querySelectorAll('.media-section').forEach(element => {
      const transcriptContainer = element.querySelector(".video-transcript-container");

      if (transcriptContainer) {
        magna.createVideoTranscript({
          element: transcriptContainer,
          source: element.querySelector("video source[transcript]")
        })
      }
    })

    </script>
{% endblock %}
