{% extends 'core/base.html' %}
{% load wagtailimages_tags %}
{% load routablepageurl from wagtailroutablepage_tags %}
{% load url_map %}
{% load content_tags %}
{% block content %}
    <div class="great lesson-page">
        {% get_category_title_for_lesson page as category_title %}
    
            <div class="great-container lesson-body govuk-!-padding-top-9">
                <div>
                    <div class="govuk-grid-column-two-thirds-from-desktop govuk-!-padding-0">
                        <h2 class="govuk-caption-xl">{{page.get_lesson_category_name}}</h2>
                        <h1 class="govuk-heading-xl" id="lesson-title">{{ page.title }}</h1>
                        {% if page.hero%}
                            <div class="lesson-hero media-section">{% include 'learn/hero_media_item.html' %}</div>
                        {% endif %}
                        {% include 'core/objectives.html' %}
                        <div class="lesson-body-blocks">{% include 'core/personalised_body.html' %}</div>
                    </div>
                </div>    
            </div>
    </div>
    <div class="great test-knowledge">
        {% if request.user.is_authenticated %}
            <div class="great-container govuk-!-padding-top-8">
                <div class="">
                    {% include 'learn/recap.html' %}
                    <hr class="hr hr--light govuk-!-margin-0" />
                </div>
            </div>
            <div class="great-container govuk-!-padding-bottom-8">
                <fieldset id="mark_as_complete">
                </fieldset>
            </div>
       {% endif %} 
        <div class="great great-container">
           
                    {% if next_lesson %}
                        {% include "./return_link.html" with link=backlink title=backlink_title class="only-mobile" %}
                        <div class="card card--horizontal">
                            <div class="govuk-!-padding-6">
                                <p class="govuk-body great-font-bold govuk-!-margin-0">Your next lesson</p>
                                <h2 class="govuk-heading-l govuk-!-padding-top-2">{{ next_lesson.title }}</h2>
                                {% if next_module %}
                                    <p class="govuk-!-margin-top-3 govuk-!-margin-bottom-3">
                                        Part of your next module:
                                        <br />
                                        <strong>{{ next_module.title }}</strong>
                                    </p>
                                {% endif %}
                                <a href="{{ next_lesson.get_url }}" class="button primary-button govuk-!-static-margin-top-4">Continue learning</a>
                            </div>
                            <div class="card__section card__section--image">
                                <div class="card__image great-container">
                                    {% comment %}<!--
                  If `next_module` is present, we want to use the image from that ahead of `current_module`
                                    -->{% endcomment %}
                                    {% with next_module|default:current_module as appropriate_module %}
                                        {% image appropriate_module.image original as module_image %}
                                        <img src="{{ module_image.url }}" alt="{{ module_image.alt }}" />
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
            
        </div>
    </div>
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script>
    {% if request.user.is_authenticated %}
      dataLayer.push({
        event: 'lessonView',
        lessonModule: '{{ current_module }}',
        topicTitle: '{{ page_topic }}',
        lessonTitle: '{{ page.title }}'
      });
      magna.createMarkLessonAsComplete({
        element: document.querySelector("#mark_as_complete"),
        endpoint: '{% url "sso:lesson-completed" lesson=page.id %}'
      })
    {% endif %}

    document.querySelectorAll('.media-section').forEach(element => {
      const transcriptContainer = element.querySelector(".video-transcript-container");

      if (transcriptContainer) {
        magna.createVideoTranscript({
          element: transcriptContainer,
          source: element.querySelector("video source[transcript]")
        })
      }
    })

    </script>
{% endblock %}