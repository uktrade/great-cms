{% extends 'core/base.html' %}
{% load wagtailimages_tags %}
{% load routablepageurl from wagtailroutablepage_tags %}
{% load url_map %}
{% load content_tags %}
{% block content %}
    {% load breadcrumbs from component_tags %}
    <div class="great-container">
        {% breadcrumbs page great-breadcrumbs %}
        <a href={{ BREADCRUMBS_ROOT_URL|default:"/" }}>great.gov.uk</a>
        <a href="/learn/categories/">Learn to export</a>
        <a href={{ page.get_parent.get_parent.url }}>{{ page.get_parent.get_parent.title|default:"/" }}</a>
    {% endbreadcrumbs %}
</div>
<div class="great lesson-page">
    {% get_category_title_for_lesson page as category_title %}
    <div class="great-container lesson-body govuk-!-padding-top-9">
        <div>
            <div class="govuk-grid-column-two-thirds-from-desktop govuk-!-padding-0">
                <h2 class="govuk-caption-xl">{{ page.get_lesson_category_name }}</h2>
                <h1 class="govuk-heading-xl" id="lesson-title">{{ page.title }}</h1>
                {% if page.hero %}
                    <div class="lesson-hero media-section">{% include 'learn/hero_media_item.html' %}</div>
                {% endif %}
                {% include 'core/objectives.html' %}
                <div class="lesson-body-blocks">{% include 'core/personalised_body.html' %}</div>
            </div>
        </div>
    </div>
</div>
<div class="great great-bg-white">
    <div class="great-container">
        <div class="govuk-grid-column-two-thirds-from-desktop govuk-!-padding-0">
            {% if request.user.is_authenticated %}
                <div class="great-bg-light-blue great-border-top-orange govuk-!-padding-6 ">
                    <div class="">
                        <div class="">
                            {% include 'learn/recap.html' %}
                            <hr class="hr hr--light govuk-!-margin-0" />
                        </div>
                    </div>
                    <div class="govuk-!-padding-bottom-2">
                        <fieldset id="mark_as_complete">
                        </fieldset>
                    </div>
                </div>
            {% endif %}
            {% if next_lesson %}
                <div class="govuk-!-padding-top-6 govuk-!-padding-bottom-8">
                    <h2 class="govuk-heading-m govuk-!-padding-top-2">
                        {% if next_module %}
                            Part of your next module
                        {% else %}
                            Next in this topic
                        {% endif %}
                    </h2>
                    <a data-learn-to-export-link="{{ next_lesson.get_url }}"
                    class="great-inline-flex no-wrap"
                    href="{{ next_lesson.get_url }}"> <span role="img"
        class="fa fa-arrow-right great-text-white great-icon-circular-background govuk-!-margin-right-3 great-no-text-decoration"></span>
                    <span class="great-title-link great-inline govuk-heading-xs great-font-bold">{{ next_lesson.title }}</span>
                    </a>
                    <hr class="great-blue-hr govuk-!-margin-top-8 govuk-!-margin-bottom-6" />
                    <h3 class="govuk-heading-s">Explore the topic</h3>
                    <a data-learn-to-export-link="{{ page.get_next_lesson_category.url }}"
                    href="{{ page.get_next_lesson_category.url }}"
                    class="govuk-link great-font-bold">{{ page.get_next_lesson_category.title }}</a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% include 'learn/promo.html' with bg_class='great-bg-light-blue' %}
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script>
    {% if request.user.is_authenticated %}
      dataLayer.push({
        event: 'lessonView',
        lessonModule: '{{ current_module }}',
        topicTitle: '{{ page_topic }}',
        lessonTitle: '{{ page.title }}'
      });
      magna.createMarkLessonAsComplete({
        element: document.querySelector("#mark_as_complete"),
        endpoint: '{% url "sso:lesson-completed" lesson=page.id %}'
      })
    {% endif %}

    document.querySelectorAll('.media-section').forEach(element => {
      const transcriptContainer = element.querySelector(".video-transcript-container");

      if (transcriptContainer) {
        magna.createVideoTranscript({
          element: transcriptContainer,
          source: element.querySelector("video source[transcript]")
        })
      }
    })

    </script>
{% endblock %}
