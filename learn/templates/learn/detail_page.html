{% extends 'core/base.html' %}
{% load wagtailimages_tags %}
{% load routablepageurl from wagtailroutablepage_tags %}
{% load url_map %}
{% load content_tags %}
{% block content %}
    {% load breadcrumbs from component_tags %}
    <div class="great-container">
        {% breadcrumbs great-breadcrumbs %}
        <a href={{ BREADCRUMBS_ROOT_URL|default:"/" }}>great.gov.uk</a>
        <a href="/learn/categories/">Learn to export</a>
        <a href={{ page.get_parent.get_parent.url }}>{{ page.get_parent.get_parent.title|default:"/" }}</a>
    {% endbreadcrumbs %}
</div>
<div class="great lesson-page">
    {% get_category_title_for_lesson page as category_title %}
    <div class="great-container govuk-!-padding-top-9">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds-from-desktop">
                <h2 class="govuk-caption-xl">{{ page.get_lesson_category_name }}</h2>
                <h1 class="govuk-heading-xl" id="lesson-title">{{ page.title }}</h1>
            </div>
        </div>
    </div>
</div>
<div class="great great-bg-white lesson-page">
    <div class="great-container">
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds-from-desktop">
                {% if page.hero %}
                    <div class="lesson-hero media-section">{% include 'learn/hero_media_item.html' %}</div>
                {% endif %}
                {% include 'core/objectives.html' %}
                <div class="lesson-body-blocks">{% include 'core/personalised_body.html' %}</div>
                {% if request.user.is_authenticated %}
                    <div class="great-bg-light-blue great-border-top-orange govuk-!-padding-6 ">
                        <div>
                            <div>
                                {% include 'learn/recap.html' %}
                                <hr class="hr hr--light govuk-!-margin-0" />
                            </div>
                        </div>
                        <div class="govuk-!-padding-bottom-2">
                            <fieldset id="mark_as_complete">
                            </fieldset>
                        </div>
                    </div>
                {% endif %}
                {% if next_lesson %}
                    <div class="govuk-!-padding-top-6 govuk-!-padding-bottom-8">
                        {% if not next_module %}
                            <h2 class="govuk-heading-m govuk-!-padding-top-2">Next in this topic</h2>
                            {% include 'components/great/arrow_link.html' with url=next_lesson.get_url title=next_lesson.title %}
                        {% endif %}
                        <hr class="great-hr-light {% if not next_module %}govuk-!-margin-top-8{% else %}govuk-!-margin-top-4{% endif %} govuk-!-margin-bottom-4" />
                        <h3 class="govuk-heading-s">Explore the topic</h3>
                        <a data-learn-to-export-link="{{ page.get_current_module.url }}"
                           href="{{ page.get_current_module.url }}"
                           class="govuk-link great-font-bold">{{ page.get_current_module.title }}</a>
                    </div>
                {% endif %}
            </div>
            <div class="govuk-grid-column-one-third-from-desktop">
                {% include 'core/steps.html' with steps=page.get_steps title='Learn to export topics' current_step_url=page.get_current_module.url %}
                {% include 'learn/includes/article_page_cta.html' %}
                {% if features.FEATURE_SHARE_COMPONENT %}
                    {% include 'components/great/share.html' with page_url=request.build_absolute_uri page_title=page.title %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
<div class="govuk-grid-column-full govuk-!-padding-0">
    {% include 'learn/promo.html' with bg_class='great-bg-light-blue' %}
</div>
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script>
    {% if request.user.is_authenticated %}
      dataLayer.push({
        event: 'lessonView',
        lessonModule: '{{ current_module }}',
        topicTitle: '{{ page_topic }}',
        lessonTitle: '{{ page.title }}'
      });
      magna.createMarkLessonAsComplete({
        element: document.querySelector("#mark_as_complete"),
        endpoint: '{% url "sso:lesson-completed" lesson=page.id %}'
      })
    {% endif %}

    document.querySelectorAll('.media-section').forEach(element => {
      const transcriptContainer = element.querySelector(".video-transcript-container");

      if (transcriptContainer) {
        magna.createVideoTranscript({
          element: transcriptContainer,
          source: element.querySelector("video source[transcript]")
        })
      }
    })

    </script>
{% endblock %}
