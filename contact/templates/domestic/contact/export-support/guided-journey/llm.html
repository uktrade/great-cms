{% extends 'domestic/contact/export-support/guided-journey/base.html' %}
{% load static %}
{% block head_title %}Export support for UK businesses{% endblock %}


{% block head_css %}
    {{ block.super }}

    <style>
        .loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .loader {
            width: 50px;
            aspect-ratio: 1;
            display: grid;
        }
        .loader::before,
        .loader::after {    
            content:"";
            grid-area: 1/1;
            --c:no-repeat radial-gradient(farthest-side,#25b09b 92%,#0000);
            background: 
                var(--c) 50%  0, 
                var(--c) 50%  100%, 
                var(--c) 100% 50%, 
                var(--c) 0    50%;
            background-size: 12px 12px;
            animation: l12 1s infinite;
        }
        .loader::before {
            margin: 4px;
            filter: hue-rotate(45deg);
            background-size: 8px 8px;
            animation-timing-function: linear
        }

        @keyframes l12 { 
            100% {transform: rotate(.5turn)}
        }
    </style>
{% endblock %}

{% block content %}
    <div class="great">
        <div class="great-container govuk-!-padding-top-9">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-full govuk-!-margin-bottom-9">
                    {% if task_id == '67890' %}
                    <h1 class="govuk-heading-l govuk-!-margin-bottom-4">How do I grow my {{ session_data.commodity_name }} business in {{ session_data.market }}?</h1>
                    {% elif task_id == '12345' %}
                    <h1 class="govuk-heading-l govuk-!-margin-bottom-4">How do I export {{ session_data.commodity_name }} to {{ session_data.market }}?</h1>
                    {% endif %}
                    <div id="llm_response_text">
                        <div class="loader-container">
                            <div class="loader"></div> {{ content }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
{% endblock %}

{% block body_js %}
    {{ block.super }}

    <script>
        fetch('/api/llm/{{ task_id }}')
            .then((res) => res.json())
            .then(
            ({error, response}) => {
                if (error) {
                    document.getElementById('llm_response_text').innerHTML = 'Sorry, something went wrong';
                } else {
                    const parts = response.split('\n');

                    let html_string = ''

                    parts.forEach(part => {
                        html_string += `<p>${part}</p>`
                    })

                    document.getElementById('llm_response_text').innerHTML = html_string;

                    fetch('/api/llm/{{ task_id }}', {
                        method: "POST",
                        body: JSON.stringify({ llm_response: html_string }),
                    })
                    .then((res) => res.text())
                    .then(
                        (text) => {
                            console.log(text);
                        },
                        (error) => {
                            console.log(error);
                        })
                }
            },
            (error) => {
                console.log(error)
            })
    </script>
{% endblock %}
