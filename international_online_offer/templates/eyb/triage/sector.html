{% extends '../base.html' %}
{% load static %}
{% block head_title %}
    {% if form.sector_sub.errors %}Error:{% endif %}
    What is your business sector?
    {{ block.super }}
{% endblock %}
{% block meta_title %}What is your business sector? {{ block.super }}{% endblock %}
{% block head_css %}
    {{ block.super }}
    <link href="{% static 'core/css/accessible-autocomplete.min.css' %}"
          rel="stylesheet"
          type="text/css">
{% endblock %}
{% block content %}
    <div class="govuk-width-container great-container">
        {% include '../includes/triage_header.html' with back_url=back_url step_text=step_text %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <form method="post" onsubmit="return onSubmitSector()">
                    {% csrf_token %}
                    <div class="govuk-grid-row">
                        <div class="govuk-grid-column-full">
                            <h1 class="govuk-label-wrapper">
                                <label for='js-sector-select' class="govuk-label govuk-label--l">{{ question_text }}</label>
                            </h1>
                        </div>
                    </div>
                    <div class="govuk-grid-row govuk-!-margin-bottom-7">
                        <div class="govuk-grid-column-full">
                            <div class="{% if form.sector_sub.errors %} govuk-form-group--error{% endif %}">
                                {% include 'international/includes/form_field.html' with field=form.sector_sub %}
                            </div>
                        </div>
                    </div>
                    <div id="sic-sector-information-container"
                         class="govuk-grid-row"
                         style="{% if sector|length == 1 or sector_sub|length == 1 %} display: none {% endif %}">
                        <div class="govuk-grid-column-two-thirds">
                            <div class="govuk-inset-text">
                                <span id="sic-text">{{ sector_sub }}</span> is in our <span id="sector-text" class="govuk-!-font-weight-bold">{{ sector }}</span> sector, we will tailor your guide to this sector.
                            </div>
                        </div>
                    </div>
                    <div class="govuk-grid-row govuk-!-margin-top-3 govuk-!-margin-bottom-3">
                        <div class="govuk-grid-column-full">{% include '../includes/submit_button.html' with button_text='Continue' %}</div>
                    </div>
                </form>
            </div>
        </div>
        {% include '../includes/triage_footer.html' with why_we_ask_this_question_text=why_we_ask_this_question_text %}
    </div>
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script type="text/javascript"
            src="{% static 'javascript/accessible-autocomplete.min.js' %}"></script>
    <script type="text/javascript">
        const sectorsAndSICSectors = JSON.parse("{{autocomplete_sector_data | escapejs}}").data;
        const sicTextContainer = document.querySelector('#sic-text');
        const sicSectorInfoContainer = document.querySelector('#sic-sector-information-container');
        const sectorTextContainer = document.querySelector('#sector-text');
        const getSICSectors = (dataIn) => {
            const sectors = [];
            for (let i = 0; i < dataIn.length; i++) {
                sectors.push(dataIn[i].sic_description);
            }
            return sectors;
        }

        const getSectorForSICSector = (sicSector) => {
            for (let i = 0; i < sectorsAndSICSectors.length; i++) {
                if (sectorsAndSICSectors[i].sic_description == sicSector) {
                    return sectorsAndSICSectors[i].dit_sector_list_field_04;
                }
            }
        }
        const sicSectors = getSICSectors(sectorsAndSICSectors)

        function sectorSuggest(query, populateResults) {
            if (!query) return [];
            let results = [];
            for (let i = 0; i < sectorsAndSICSectors.length; i++) {
                const dbtSector = sectorsAndSICSectors[i].dit_sector_list_field_04;
                const sicSector = sectorsAndSICSectors[i].sic_description;
                if (dbtSector.toLowerCase().indexOf(query.toLowerCase()) !== -1 || sicSector.toLowerCase().indexOf(query.toLowerCase()) !== -1) {
                    results.push(sicSector);
                }
            }
            populateResults(results);
        }

        accessibleAutocomplete.enhanceSelectElement({
        selectElement: document.getElementById('js-sector-select'),
        source: sectorSuggest,
        autoselect: false,
        templates: {
            suggestion: (selectedSIC) => {
                const sicSector = getSectorForSICSector(selectedSIC);
                return `<span>${selectedSIC}</span><br><span class='govuk-!-font-size-16'>${sicSector}</span>`;
            }
        },
        minLength: 2,
        onConfirm: function(selectedText) {
            // onConfirm seems to be triggered by autocomplete many times passing null
            if (selectedText) {
                // When overriding onconfirm as per docs, it seems to then not automatically update
                // the actual select elements selected value and so isnt posted on form submit
                const sectorSelectInput = document.querySelector('#js-sector-select-select');
                const setSectorSelectValue = (value) => {
                    for (let i = 0; i < sectorSelectInput.options.length; i++) {
                        if (sectorSelectInput.options[i].text === selectedText) {
                            sectorSelectInput.selectedIndex = i;
                            break;
                        }
                    }
                }
                setSectorSelectValue(selectedText);
                // Hide / show information around the sector that the SIC sector is in
                const sector = getSectorForSICSector(selectedText)
                if (sector) {
                    sicTextContainer.innerText = selectedText;
                    sectorTextContainer.innerText = sector;
                    sicSectorInfoContainer.style.display = '';
                } else {
                    sicSectorInfoContainer.style.display = 'none';
                }
            }
        }
        });
    </script>
    <script type="text/javascript">autocompleteFocusOnESC('#js-sector-select', '#js-sector-select__listbox')</script>
{% endblock %}
