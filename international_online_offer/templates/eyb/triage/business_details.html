{% extends '../base.html' %}
{% load static %}
{% block head_title %}
    {% if form.errors %}Error:{% endif %}
    About your business: business details. {{ block.super }}
{% endblock %}
{% block meta_title %}About your business: business details. {{ block.super }}{% endblock %}
{% block head_other %}
    <meta name="description"
          content="Find information to help invest within the UK" />
{% endblock %}
{% block head_css %}
    <link href="{% static 'core/css/accessible-autocomplete.min.css' %}"
          rel="stylesheet"
          type="text/css">
    {{ block.super }}
{% endblock %}
{% block content %}
    <div class="great-container">
        {% include '../includes/triage_header.html' with back_url=back_url %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <form method="post" onsubmit="return onSubmitBusinessDetails()">
                    {% csrf_token %}
                    <h2 class="govuk-caption-l">
                        <span class="govuk-visually-hidden">This section is</span>About your business
                    </h2>
                    <fieldset class="govuk-fieldset">
                        <legend class="govuk-fieldset__legend govuk-fieldset__legend--l govuk-!-margin-bottom-6">
                            <h1 class="govuk-fieldset__heading">Business details</h1>
                        </legend>
                        <div class="govuk-form-group">
                            {% include 'international/includes/form_field.html' with field=form.company_name show_vertical_error_line=True %}
                        </div>
                        <div class="govuk-form-group">
                            {% include 'international/includes/form_field.html' with field=form.sector_sub show_vertical_error_line=True %}
                        </div>
                        <div class="govuk-form-group">
                            {% include 'international/includes/form_field.html' with field=form.company_location show_vertical_error_line=True %}
                        </div>
                        <div class="govuk-form-group">
                            {% include 'international/includes/form_field.html' with field=form.company_website show_vertical_error_line=True %}
                        </div>
                    </fieldset>
                    <div class="govuk-grid-row">
                        <div class="govuk-grid-column-full">
                            {% include 'international/includes/submit_button.html' with button_text='Save and continue' %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script type="text/javascript"
            src="{% static 'javascript/accessible-autocomplete.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'javascript/countries.js' %}"></script>
    <script type="text/javascript"
            src="{% static 'javascript/expand-your-business.js' %}"></script>
    <script type="text/javascript">
        const onSubmitBusinessDetails = () => {
            if (!document.getElementById('js-sector-select').value) {
                document.getElementById('js-sector-select-select').value = '';
            }
            if (!document.getElementById('js-company-location-select').value) {
                document.getElementById('js-company-location-select-select').value = '';
            }
        }

        accessibleAutocomplete.enhanceSelectElement({
            selectElement: document.getElementById('js-company-location-select'),
            source: countries,
            autoselect: false,
            minLength: 2,
        });
    </script>
    <script>
        const allSectors = JSON.parse("{{autocomplete_sector_data | escapejs}}");

        function sortResults(sectors) {
            return sectors.sort((a, b) => {
                if (a.sub_sub_sector_name && !b.sub_sub_sector_name) return -1;
                if (!a.sub_sub_sector_name && b.sub_sub_sector_name) return 1;

                // Sort alphabetically by sub_sub_sector_name if both are present
                if (a.sub_sub_sector_name < b.sub_sub_sector_name) return -1;
                if (a.sub_sub_sector_name > b.sub_sub_sector_name) return 1;

                // Sort by presence of sub_sector_name if sub_sub_sector_name is equal
                if (a.sub_sector_name && !b.sub_sector_name) return -1;
                if (!a.sub_sector_name && b.sub_sector_name) return 1;

                // Sort alphabetically by sub_sector_name if both are present or both are empty
                if (a.sub_sector_name < b.sub_sector_name) return -1;
                if (a.sub_sector_name > b.sub_sector_name) return 1;

                // Sort alphabetically by sector_name if both sub_sub_sector_name and sub_sector_name are equal
                if (a.sector_name < b.sector_name) return -1;
                if (a.sector_name > b.sector_name) return 1;

                return 0;
            });
        }

        function sectorSuggest(query, populateResults) {
            if (!query) return [];
            let results = [];
            for (let i = 0; i < allSectors.length; i++) {
                const parentSector = allSectors[i].sector_name;
                let subSector = allSectors[i].sub_sector_name || '';
                let subSubSector = allSectors[i].sub_sub_sector_name || '';
                if (parentSector.toLowerCase().indexOf(query.toLowerCase()) !== -1 || subSector.toLowerCase().indexOf(query.toLowerCase()) !== -1 || subSubSector.toLowerCase().indexOf(query.toLowerCase()) !== -1) {
                    results.push(allSectors[i]);
                }
            }
            results = sortResults(results);
            populateResults(results);
        }

        accessibleAutocomplete.enhanceSelectElement({
            selectElement: document.getElementById('js-sector-select'),
            source: sectorSuggest,
            autoselect: false,
            templates: {
                inputValue: (selectedSectorRow) => {
                    if (selectedSectorRow) {
                        if (selectedSectorRow.sub_sub_sector_name) {
                            return selectedSectorRow.sub_sub_sector_name;
                        } else if (selectedSectorRow.sub_sector_name) {
                            return selectedSectorRow.sub_sector_name;
                        } else {
                            return selectedSectorRow.sector_name
                        }
                    } else {
                        return
                    }
                },
                suggestion: (selectedSectorRow) => {
                    if (typeof selectedSectorRow !== 'object') {
                        return selectedSectorRow
                    }
                    if (selectedSectorRow.sub_sub_sector_name) {
                        return `<span>${selectedSectorRow.sub_sub_sector_name}</span><br><span class='govuk-!-font-size-16 eyb-sector-lookup-second-row'>${selectedSectorRow.sector_name} &#8250; ${selectedSectorRow.sub_sector_name}</span>`;
                    } else if (selectedSectorRow.sub_sector_name) {
                        return `<span>${selectedSectorRow.sub_sector_name}</span><br><span class='govuk-!-font-size-16 eyb-sector-lookup-second-row'>${selectedSectorRow.sector_name}</span>`;
                    } else {
                        return `<span>${selectedSectorRow.sector_name}</span>`
                    }
                }
            },
            minLength: 2,
            onConfirm: function(selectedRow) {
                // onConfirm seems to be triggered by autocomplete many times passing null
                if (selectedRow) {
                    // When overriding onconfirm as per docs, it seems to then not automatically update
                    // the actual select elements selected value and so isnt posted on form submit
                    const sectorSelectInput = document.querySelector('#js-sector-select-select');
                    console.log(selectedRow)
                    const setSectorSelectValue = (value) => {
                        for (let i = 0; i < sectorSelectInput.options.length; i++) {
                            if (sectorSelectInput.options[i].value === selectedRow.sector_id) {
                                sectorSelectInput.selectedIndex = i;
                                break;
                            }
                        }
                    }
                    setSectorSelectValue(selectedRow);
                }
            }
        });
    </script>
{% endblock %}
