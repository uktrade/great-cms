{% extends '../base.html' %}
{% load static %}
{% block head_title %}About your business: business details. {{ block.super }}{% endblock %}
{% block meta_title %}About your business: business details. {{ block.super }}{% endblock %}
{% block head_other %}
    <meta name="description"
          content="Find information to help invest within the UK" />
{% endblock %}
{% block head_css %}
    {{ block.super }}
    <link href="{% static 'core/css/accessible-autocomplete.min.css' %}"
          rel="stylesheet"
          type="text/css">
{% endblock %}
{% block content %}
    <div class="govuk-width-container great-container">
        {% include '../includes/triage_new_header.html' with back_url=back_url hint_title='About your business' title='Business details' %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                <form method="post" onsubmit="return onSubmitBusinessDetails()">
                    {% csrf_token %}
                    <div class="govuk-grid-row govuk-!-margin-bottom-4">
                        <div class="govuk-grid-column-full">
                            <div class="{% if form.company_name.errors %} govuk-form-group--error{% endif %}">
                                {% include '../includes/form_field.html' with field=form.company_name %}
                            </div>
                        </div>
                    </div>
                    <div class="govuk-grid-row govuk-!-margin-bottom-4">
                        <div class="govuk-grid-column-full">
                            <div class="{% if form.sector_sub.errors %} govuk-form-group--error{% endif %}">
                                {% include '../includes/form_field.html' with field=form.sector_sub %}
                            </div>
                        </div>
                    </div>
                    <div id="sic-sector-information-container"
                         class="govuk-grid-row"
                         style="{% if not sector or not sector_sub %} display: none {% endif %}">
                        <div class="govuk-grid-column-full">
                            <div class="govuk-inset-text govuk-!-margin-top-0 govuk-!-margin-bottom-3">
                                <span id="sic-text">{{ sector_sub }}</span> is in our <span id="sector-text" class="govuk-!-font-weight-bold">{{ sector }}</span> sector, we will tailor your guide to this sector.
                            </div>
                        </div>
                    </div>
                    <div class="govuk-grid-row govuk-!-margin-bottom-4">
                        <div class="govuk-grid-column-full">
                            <div class="{% if form.company_location.errors %} govuk-form-group--error{% endif %}">
                                {% include '../includes/form_field.html' with field=form.company_location %}
                            </div>
                        </div>
                    </div>
                    <div class="govuk-grid-row govuk-!-margin-bottom-4">
                        <div class="govuk-grid-column-full">
                            <div class="{% if form.company_website.errors %} govuk-form-group--error{% endif %}">
                                {% include '../includes/form_field.html' with field=form.company_website %}
                            </div>
                        </div>
                    </div>
                    <div class="govuk-grid-row govuk-!-margin-top-5">
                        <div class="govuk-grid-column-full">
                            {% include '../includes/submit_button.html' with button_text='Save and continue' %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block body_js %}
    {{ block.super }}
    <script type="text/javascript"
            src="{% static 'javascript/accessible-autocomplete.min.js' %}"></script>
    <script type="text/javascript"
            src="{% static 'javascript/expand-your-business.js' %}"></script>
    <script type="text/javascript">
        const onSubmitBusinessDetails = () => {
            if (!document.getElementById('js-sector-select').value) {
                document.getElementById('js-sector-select-select').value = '';
            }
            if (!document.getElementById('js-company-location-select').value) {
                document.getElementById('js-company-location-select-select').value = '';
            }
        }

        const countries = [
            'Afghanistan','Albania','Algeria','Andorra','Angola','Antigua and Barbuda','Argentina','Armenia','Australia','Austria','Azerbaijan','Bahrain','Bangladesh','Barbados','Belarus','Belgium','Belize','Benin','Bhutan','Bolivia','Bosnia and Herzegovina','Botswana','Brazil','Brunei','Bulgaria','Burkina Faso','Burundi','Cambodia','Cameroon','Canada','Cape Verde','Central African Republic','Chad','Chile','China','Colombia','Comoros','Congo','Congo (Democratic Republic)','Costa Rica','Croatia','Cuba','Cyprus','Czechia','Denmark','Djibouti','Dominica','Dominican Republic','East Timor','Ecuador','Egypt','El Salvador','Equatorial Guinea','Eritrea','Estonia','Eswatini','Ethiopia','Fiji','Finland','France','Gabon','Georgia','Germany','Ghana','Greece','Grenada','Guatemala','Guinea','Guinea-Bissau','Guyana','Haiti','Honduras','Hungary','Iceland','India','Indonesia','Iran','Iraq','Ireland','Israel','Italy','Ivory Coast','Jamaica','Japan','Jordan','Kazakhstan','Kenya','Kiribati','Kosovo','Kuwait','Kyrgyzstan','Laos','Latvia','Lebanon','Lesotho','Liberia','Libya','Liechtenstein','Lithuania','Luxembourg','Madagascar','Malawi','Malaysia','Maldives','Mali','Malta','Marshall Islands','Mauritania','Mauritius','Mexico','Micronesia','Moldova','Monaco','Mongolia','Montenegro','Morocco','Mozambique','Myanmar (Burma)','Namibia','Nauru','Nepal','Netherlands','New Zealand','Nicaragua','Niger','Nigeria','North Korea','North Macedonia','Norway','Oman','Pakistan','Palau','Panama','Papua New Guinea','Paraguay','Peru','Philippines','Poland','Portugal','Qatar','Romania','Russia','Rwanda','Samoa','San Marino','Sao Tome and Principe','Saudi Arabia','Senegal','Serbia','Seychelles','Sierra Leone','Singapore','Slovakia','Slovenia','Solomon Islands','Somalia','South Africa','South Korea','South Sudan','Spain','Sri Lanka','St Kitts and Nevis','St Lucia','St Vincent','Sudan','Suriname','Sweden','Switzerland','Syria','Tajikistan','Tanzania','Thailand','The Bahamas','The Gambia','Togo','Tonga','Trinidad and Tobago','Tunisia','Turkey','Turkmenistan','Tuvalu','Uganda','Ukraine','United Arab Emirates','United Kingdom','United States','Uruguay','Uzbekistan','Vanuatu','Vatican City','Venezuela','Vietnam','Yemen','Zambia','Zimbabwe'
        ]
        accessibleAutocomplete.enhanceSelectElement({
            selectElement: document.getElementById('js-company-location-select'),
            source: countries,
            autoselect: false,
            minLength: 2,
        });

        const sectorsAndSICSectors = JSON.parse("{{autocomplete_sector_data | escapejs}}").data;
        const sicTextContainer = document.querySelector('#sic-text');
        const sicSectorInfoContainer = document.querySelector('#sic-sector-information-container');
        const sectorTextContainer = document.querySelector('#sector-text');
        const getSICSectors = (dataIn) => {
            const sectors = [];
            for (let i = 0; i < dataIn.length; i++) {
                sectors.push(dataIn[i].sic_description);
            }
            return sectors;
        }

        const getSectorForSICSector = (sicSector) => {
            for (let i = 0; i < sectorsAndSICSectors.length; i++) {
                if (sectorsAndSICSectors[i].sic_description == sicSector) {
                    return sectorsAndSICSectors[i].dit_sector_list_field_04;
                }
            }
        }
        const sicSectors = getSICSectors(sectorsAndSICSectors)

        function sectorSuggest(query, populateResults) {
            if (!query) return [];
            let results = [];
            for (let i = 0; i < sectorsAndSICSectors.length; i++) {
                const dbtSector = sectorsAndSICSectors[i].dit_sector_list_field_04;
                const sicSector = sectorsAndSICSectors[i].sic_description;
                if (dbtSector.toLowerCase().indexOf(query.toLowerCase()) !== -1 || sicSector.toLowerCase().indexOf(query.toLowerCase()) !== -1) {
                    results.push(sicSector);
                }
            }
            populateResults(results);
        }

        accessibleAutocomplete.enhanceSelectElement({
        selectElement: document.getElementById('js-sector-select'),
        source: sectorSuggest,
        autoselect: false,
        templates: {
            suggestion: (selectedSIC) => {
                const sicSector = getSectorForSICSector(selectedSIC);
                return `<span>${selectedSIC}</span><br><span class='govuk-!-font-size-16'>${sicSector}</span>`;
            }
        },
        minLength: 2,
        onConfirm: function(selectedText) {
            // onConfirm seems to be triggered by autocomplete many times passing null
            if (selectedText) {
                // When overriding onconfirm as per docs, it seems to then not automatically update
                // the actual select elements selected value and so isnt posted on form submit
                const sectorSelectInput = document.querySelector('#js-sector-select-select');
                const setSectorSelectValue = (value) => {
                    for (let i = 0; i < sectorSelectInput.options.length; i++) {
                        if (sectorSelectInput.options[i].text === selectedText) {
                            sectorSelectInput.selectedIndex = i;
                            break;
                        }
                    }
                }
                setSectorSelectValue(selectedText);
                // Hide / show information around the sector that the SIC sector is in
                const sector = getSectorForSICSector(selectedText)
                if (sector) {
                    sicTextContainer.innerText = selectedText;
                    sectorTextContainer.innerText = sector;
                    sicSectorInfoContainer.style.display = '';
                } else {
                    sicSectorInfoContainer.style.display = 'none';
                }
            }
        }
        });
    </script>
{% endblock %}
